

==== JVM调优


.线程池
. 理想状态, 任务数量动态保存在核心线程和最大线程之间,
超过最大线程数的任务等待有线程空闲再执行
. 使用SynchronousQueue, 使maximumPoolSize发挥作用
. 自定义拒绝策略. 当超出最大线程数时, 定期检查线程池是否有空闲线程.
如果有, 将拒绝的任务放回线程池


.JVM调优原则
. 减少FullGC执行时间
.. 增大新生代大小, 尽量让对象在新生代就清除掉
. 减少对象进入老年代
. 通过观察峰值时期, 老年代的情况, 在不影响FullGC的情况下
.. 降低MinorGC时间
.. 降低MinorGC次数
. 新生代或老年代, 当分配内存大时带来GC时间更长和周期变长.
当分配内存小时, GC更快而且更加频繁
. 应根据对象生命周期分布情况调整
.. 如果常用对象较多, 本着减少FullGC的发生, 应增大老年代大小
.. 通过观察峰值时期, 老年代的内存情况,
在不影响FullGC的前提下, 可以增大新生代的大小.
但要给老年代预留1/3的增长空间


.针对堆的配置
. -Xms -Xmx
设置最大值和最小值
.. 为了防止垃圾回首起在最大和最小之间收缩堆而产生额外的时间,
我们通常把最大值和最小值设置为一样
. -XX:NewRadio
设置新生代和老年代之间的比例
.. 设置为2, 表示 新生代:老年代 = 1:2 +
老年代是新生代的2倍
. -XX:NewSize -XX:MaxNewSize
设置新生代大小下限
.. 将两者设置为相同, 避免年轻代收缩
. -XX:+UseParalelOldGC
为老年代开启并行收集算法
.. 在多核或大内存的服务器上, 可以为老年代开启并行收集算法
.. 默认为Seral收集


.针对栈的设置
. 设置栈的大小为256k
.. 默认一个线程会分配1M内存, 理论上可以通过降低该值以产生更多线程


.判断是否需要调优
. FullGC周期最低不低于10分钟, 执行时间不超过1s
. MinorGC执行时间不超过50ms, 约10s执行一次
. 系统没有超时日志


.linux下查看java内存情况
. jmap -heap [pid]
查看整个JVM内存状态
. jmap -histo [pid]
查看JVM堆中对象详细占用情况
. jmap -dump:file=文件名.dump [pid]
导出整个JVM内存信息 +
可以用JDK自带的visualvm工具打开dump文件


.实际情况分析
. OutOfMemoryException
.. 可能原因
... 堆太小
... 有死循环或大对象
.. 检查方法
... ps -ef |grep java
查看当前java配置, 是否是堆大小错误设置了
. errorOutstanding
栈内存溢出
.. 递归层数过多
.. 系统卡顿可能原因
... FullGC时间过长, 可能原因老年代过大导致的
.. 应用CPU占用率过高
... 可能由于FullGC频繁导致的 +
如果老年代中的大对象占用了较多内存, 会导致FullGC过于频繁


.打印GC日志
. -XX:+PrintGCDetails
输出GC的详细日志
. -loggc:C:/apps/tomcat/logs/tomcat_gc.log
设置日志生成地址
. 新生代回收日志 +
[GC 611.633: [DefNew: 843458K[新生代回收前大小]->2K[新生代回收后大小](948864K[新生代大小]), 0.0059180 secs[年轻代回收时间]] 2186589K[堆回收前大小]->1343132K[堆会回收后大小](3057292K[堆总大小]), 0.0059490 secs[堆回收时间]] [Times: user=0.00 sys=0.00, real=0.00 secs]
. 老年代回收日志
[GC 1630.821: [DefNew: 1005567K->111679K(1005568K), 0.9152360 secs]1631.736: [Tenured:2573912K->1340650K(2574068K), 1.8511050 secs] 3122548K->1340650K(3579636K), [Perm : 17882K->17882K(21248K)], 2.7854350 secs] [Times: user=2.57 sys=0.22, real=2.79 secs]


.修改JVM配置
在tomcat的bin/catalina.sh中修改


.实际调优
. 服务器物理内存
. JAVA_OPTS="-server -Xms2048m -XX:PermSize=512m -XX:MaxPermSize=512m"










